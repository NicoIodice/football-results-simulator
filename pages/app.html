<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Sport Tournament Manager</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
    <link rel="apple-touch-icon" href="../assets/favicon-app.png">
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Inline script to apply theme immediately and prevent flash -->
    <script>
        (function() {
            // Helper function to get base path
            function getBasePath() {
                const path = window.location.pathname;
                const pathParts = path.split('/').filter(p => p);
                
                if (window.location.hostname !== 'localhost' && 
                    window.location.hostname !== '127.0.0.1' && 
                    pathParts.length > 0 && 
                    !pathParts[0].endsWith('.html')) {
                    return `/${pathParts[0]}/`;
                }
                
                return '/';
            }
            
            // Get tournament context from sessionStorage
            const year = sessionStorage.getItem('selectedTournamentYear') || '2025';
            const sportType = sessionStorage.getItem('selectedTournamentSport') || 'futsal';
            
            // Fetch theme from tournament-settings.json synchronously
            const xhr = new XMLHttpRequest();
            const basePath = getBasePath();
            const settingsPath = basePath + `data/${year}/${sportType}/tournament-settings.json`;
            xhr.open('GET', settingsPath, false);
            try {
                xhr.send(null);
                if (xhr.status === 200) {
                    const settings = JSON.parse(xhr.responseText);
                    if (settings.theme === 'csw') {
                        document.documentElement.classList.add('theme-csw');
                    }
                    if (settings.theme === 'ctw') {
                        document.documentElement.classList.add('theme-ctw');
                    }
                }
            } catch (e) {
                // Fail silently - theme will be applied by JS later
            }
        })();
    </script>
</head>
<body>
    <div class="container" data-testid="main-container">
        <header data-testid="main-header">
            <h1 data-testid="header-title">Multi Sport</h1>
            <p data-testid="header-subtitle">Tournament Manager</p>
            <!-- Floating action buttons for settings and dark mode (mobile-friendly) -->
            <div class="fab-vertical-stack">
                <button id="dark-mode-toggle" class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <span class="dark-mode-icon">üåô</span>
                </button>
                <button id="settings-toggle" class="settings-toggle" onclick="showConfigModal()" title="Settings">
                    <span class="settings-icon">‚öôÔ∏è</span>
                </button>
                <button id="logout-toggle" class="settings-toggle" onclick="logout()" title="Logout">
                    <span class="settings-icon">üö™</span>
                </button>
            </div>
        </header>

        <!-- Config Modal -->
        <div id="configModal" class="modal config-modal" style="display:none;">
            <div class="modal-content config-modal-content">
                <div class="modal-header config-modal-header">
                    <h3>Configuration Settings</h3>
                    <span class="close-modal" onclick="hideConfigModal()">&times;</span>
                </div>
                <div class="config-modal-main">
                    <aside class="config-categories-panel" id="config-categories-panel">
                        <!-- Categories will be rendered here by JS -->
                    </aside>
                    <section class="config-fields-panel" id="config-fields-panel">
                        <!-- Fields for selected category will be rendered here by JS -->
                    </section>
                </div>
                <div class="modal-actions config-modal-actions">
                    <button type="button" class="btn-primary" id="config-save-btn" disabled onclick="saveConfig()">Save</button>
                </div>
            </div>
        </div>

        <nav class="tabs" data-testid="main-tabs">
            <button class="tab-button active" data-testid="tab-overview" onclick="showTab('overview')">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Overview</span>
            </button>
            <button class="tab-button" data-testid="tab-teams" onclick="showTab('teams')">
                <span class="tab-icon">üë•</span>
                <span class="tab-label">Teams</span>
            </button>
            <button class="tab-button" data-testid="tab-fixtures" onclick="showTab('fixtures')">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Fixtures</span>
            </button>
            <button class="tab-button" data-testid="tab-forecast" onclick="showTab('forecast')">
                <span class="tab-icon">üîÆ</span>
                <span class="tab-label">Forecast</span>
            </button>
            <button class="tab-button" data-testid="tab-simulator" onclick="showTab('simulator')">
                <span class="tab-icon">üéÆ</span>
                <span class="tab-label">Simulator</span>
            </button>
        </nav>

        <main id="main-content">
            <!-- Tab content will be loaded dynamically from tabs -->
        </main>
    </div>

    <!-- Add Result Modal -->
    <div id="addResultModal" class="modal" data-testid="add-result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Match Result</h3>
                <span class="close-modal" onclick="hideAddResultModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="match-info">
                    <p><strong>Match:</strong> <span id="modal-teams"></span></p>
                    <p><strong>Date & Time:</strong> <span id="modal-datetime"></span></p>
                </div>
                <form id="addResultForm" data-testid="add-result-form" onsubmit="submitResult(event)">
                    <div class="score-inputs">
                        <div class="team-score">
                            <label for="homeScore" id="homeTeamLabel"></label>
                            <input type="number" id="homeScore" min="0" max="99" required data-testid="home-score-input" oninput="updateScorerInputs()">
                        </div>
                        <div class="vs-separator">VS</div>
                        <div class="team-score">
                            <label for="awayScore" id="awayTeamLabel"></label>
                            <input type="number" id="awayScore" min="0" max="99" required data-testid="away-score-input" oninput="updateScorerInputs()">
                        </div>
                    </div>
                    
                    <!-- Scorers Section (Optional) -->
                    <div class="scorers-section" id="scorers-section" style="display: none;">
                        <div class="scorers-header">
                            <h4>‚öΩ Goal Scorers (Optional)</h4>
                            <button type="button" class="toggle-scorers-btn" onclick="toggleScorersSection()">
                                <span id="scorers-toggle-text">Show Scorers</span>
                                <span id="scorers-toggle-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="scorers-content" id="scorers-content" style="display: none;">
                            <div class="scorers-grid">
                                <div id="homeTeamScorers" class="team-scorers"></div>
                                <div id="awayTeamScorers" class="team-scorers"></div>
                            </div>
                            <p class="scorers-hint">üí° Select players and enter goals scored. Injured players are disabled.</p>
                        </div>
                    </div>
                    
                    <div class="modal-actions" data-testid="modal-actions">
                        <button type="button" class="btn-secondary" data-testid="add-result-cancel-btn" onclick="hideAddResultModal()">Cancel</button>
                        <button type="submit" class="btn-primary" data-testid="add-result-submit-btn">Add Result</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" data-testid="toast"></div>

    <!-- Loading Mask for OpenAI SDK -->
    <div id="openai-loading-mask" class="loading-mask hide" data-testid="openai-loading-mask">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">
                <h3>ü§ñ Initializing AI Engine</h3>
                <p>Loading OpenAI SDK for advanced analysis...</p>
                <div class="loading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <span class="progress-text" id="loading-progress-text">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Knockout warning popup for team replacements -->
    <div id="knockout-warning-popup" class="knockout-warning-popup" style="display: none;" data-testid="knockout-warning-popup"></div>

    <!-- Authentication check and router initialization -->
    <script type="module">
        import { requireAuth, getCurrentUsername, logout } from '../js/auth/auth.js';
        import { logger } from '../js/logger.js';
        import { initRouter } from '../js/router.js';
        
        // Check authentication before loading app
        if (!requireAuth()) {
            // requireAuth will redirect to login if not authenticated
        } else {
            // User is authenticated, log username
            logger.log('Authenticated user:', getCurrentUsername());
            
            // Initialize router for URL-based navigation
            initRouter();
            
            // Make logout available globally
            window.logout = logout;
        }
    </script>
    
    <!-- Main application script (imports all modules) -->
    <script type="module" src="../js/app.js"></script>
</body>
</html>